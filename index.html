<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Tasks</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="material/css/styles.css">
    <style>
        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: url('material/images/loading.gif') no-repeat center center fixed;
            background-size: cover;
            color: white;
            text-align: center;
            font-family: Arial, sans-serif;
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 10;
        }

        .loading-container h1 {
            font-size: 24px;
            margin: 0;
        }

        .spinner {
            border: 8px solid rgba(255, 255, 255, 0.1);
            border-left: 8px solid #d5d7dd;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-top: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Ø¨Ø§Ù‚ÙŠ ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„ØµÙØ­Ø© */
        body.loaded {
            overflow: auto;
        }

        .hidden {
            display: none;
        }

        #balance-container {
            margin: 20px;
            font-size: 18px;
        }

        .task-container {
            margin: 10px auto;
            max-width: 600px;
        }
    </style>
</head>
<body>
    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
    <div class="loading-container" id="loading-screen">
        <div>
            <h1>Loading...</h1>
            <div class="spinner"></div>
        </div>
    </div>

    <!-- Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div id="main-content" class="hidden">
        <div id="balance-container">
            <h2 id="username">Welcome, <b>User</b>!</h2>
            <span id="balance">0</span> ğŸ¦´ total dogs
        </div>
        <br>

        <div class="task-container">
            <!-- Ø§Ù„Ù…Ù‡Ø§Ù… -->
            <div class="task">
                <div class="task-detail">
                    <div class="task-image">
                        <img src="material/images/logo.png" width="45px" alt="">
                    </div>
                    <div>
                        <h4>claim rewards</h4>
                        <div class="task-data">
                            <img src="material/images/logo.png" width="20px" alt="Coin Icon">
                            <h5>300</h5>
                        </div>
                    </div>
                </div>
                <button class="task-button" onclick="completeTask(300, 'reword.html')">ğŸ¦´ claim</button>
            </div>
        </div>

        <nav class="bottom-nav">
            <a href="home.html" class="nav-item">
                <i class="fas fa-home"></i>
                <span>HOME</span>
            </a>
            <a href="leaderboard.html" class="nav-item">
                <i class="fas fa-trophy"></i>
                <span>LEADERBOARD</span>
            </a>
            <a href="invite-friends.html" class="nav-item">
                <i class="fas fa-user-friends"></i>
                <span>FRIENDS</span>
            </a>
            <a href="task.html" class="nav-item">
                <i class="fas fa-tasks"></i>
                <span>TASKS</span>
            </a>
            <a href="balance.html" class="nav-item">
                <i class="fas fa-wallet"></i>
                <span>BALANCE</span>
            </a>
        </nav>
    </div>

 <script type="module">
    // Import Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";
    import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-database.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-auth.js";

    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBaHujfhSY-Hd_u-CzsAqIfZ9eGMree4Oo",
        authDomain: "mychessgame-7811e.firebaseapp.com",
        projectId: "mychessgame-7811e",
        storageBucket: "mychessgame-7811e.firebasestorage.app",
        messagingSenderId: "512952991572",
        appId: "1:512952991572:web:eae4a9c91bbfc0552b92c1",
        measurementId: "G-HKH7LH05V0"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const auth = getAuth();

    // Extract userId and username from URL
    function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
    }
    const userId = getQueryParam("userId") || "defaultUser";
    const username = getQueryParam("username") || "User";

    // ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù…Ø¬Ù‡ÙˆÙ„
    signInAnonymously(auth).then(() => {
        console.log('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­');
        fetchOrInitializeUserData();
    }).catch((error) => {
        console.error('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', error.message);
    });

    // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø£Ùˆ ØªÙ‡ÙŠØ¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase
    function fetchOrInitializeUserData() {
        const userRef = ref(database, `users/${userId}`);

        get(userRef).then((snapshot) => {
            if (snapshot.exists()) {
                const userData = snapshot.val();
                console.log("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯Ø©:", userData);

                // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                displayUserData(userData.username || username, userData.points);
            } else {
                console.log("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ØŒ Ø¬Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø· Ù…Ø¬Ø§Ù†ÙŠØ©...");
                const initialData = {
                    username: username,
                    points: 5 // Ø¥Ø¶Ø§ÙØ© 5 Ù†Ù‚Ø§Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
                };

                set(userRef, initialData).then(() => {
                    displayUserData(initialData.username, initialData.points);
                }).catch((error) => {
                    console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:", error.message);
                });
            }
        }).catch((error) => {
            console.error("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error.message);
        });
    }

    // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„ØµÙØ­Ø©
    function displayUserData(username, points) {
        document.getElementById("username").innerHTML = `Welcome, <b>${username}</b>!`;
        document.getElementById("balance").textContent = points || 0;
    }

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    window.onload = function() {
        setTimeout(() => {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            document.body.classList.add('loaded');
        }, 3000);
    };
</script>
</body>
</html>
